# Спецификация L2 POL+DAO

Данная спецификация определяет системы L2 POL+DAO, которые выпускают собственные L2 токены (L2PDT - L2 POL DAO Token), устанавливая при этом ликвидность второго уровня (L2 POL) в паре с L1 токеном Native. L2 POL+DAO могут использовать различные механизмы эмиссии, включая UTBC (однонаправленную кривую бондинга) или кастомные стратегии минтинга. Ключевые инновации включают убывающую силу голоса, прогрессивные награды за участие и микро-стриминг по блокам для устранения MEV.

---

## Оглавление

1. [Основные определения](#1-основные-определения)
2. [Системные инварианты](#2-системные-инварианты)
3. [Механика управления](#3-механика-управления)
4. [Интеграция с казначейством](#4-интеграция-с-казначейством)
5. [Жизненный цикл L2 POL+DAO](#5-жизненный-цикл-l2-poldao)
6. [Паттерн BLDR](#6-паттерн-bldr)
7. [Модель безопасности](#7-модель-безопасности)
8. [Параметры конфигурации](#8-параметры-конфигурации)
9. [Требования к реализации](#9-требования-к-реализации)

---

## 1. Основные определения

### Первичные сущности

- **Native (L1)** — Базовый токен парачейна, управляемый референдумами первого порядка на уровне L1
- **L2 POL+DAO** — DAO второго уровня, поддерживающая L2 ликвидность, принадлежащую протоколу, в паре с L1 Native
- **Ecosystem L2 POL+DAO** — L2 POL+DAO, инициализированная экосистемным origin, получающая финансирование от L1 Treasury
- **L2PDT** — L2 POL DAO Token, выпускаемый L2 POL+DAO с обязательной поддержкой POL
- **L1 POL** — Ликвидность, принадлежащая протоколу на уровне L1 (Native)
- **L2 POL** — Ликвидность, принадлежащая протоколу второго уровня в L2 POL+DAO
- **BLDR** — Канонический L2PDT токен строителей для выплат экосистеме и разработки

### Механизмы

- **UTBC** — Однонаправленная кривая токен-бондинга, один из возможных механизмов эмиссии для L2PDT (только минтинг, без выкупа)
- **Custom Emission** — Альтернативные механизмы минтинга, настраиваемые под требования L2 POL+DAO
- **DripVault** — Контракт потокового вещания по блокам для непрерывных операций казначейства
- **Declining Power** — Убывающая сила голоса от 10x до 1x в течение периода голосования
- **Progressive Rewards** — Перераспределение, создающее соотношение 1:2 между пассивными и активными участниками
- **Team Shares** — Заблокированные доли с правами управления, но без возможности передачи

---

## 2. Системные инварианты

Каждая сертифицированная L2 POL+DAO ДОЛЖНА обеспечивать соблюдение следующих инвариантов на блокчейне:

### 2.1 Управление L2 POL

LP токены, помеченные как L2 POL, могут управляться в двух режимах:

**Режим блокировки:**

- LP токены требуют для вывода:
  - Одобрение квалифицированным большинством L2 POL+DAO (≥66%)
  - Обязательная временная блокировка (14 дней)
  - Окно вето для L1 Native (7 дней)

**Режим казначейства:**

- LP токены хранятся на балансе L2 DAO Treasury
- Управляются механизмами голосования DAO
- Гибкость настраивается при инициализации POL+DAO

### 2.2 Минимальная ликвидность Native

Начальный L2 POL должен удовлетворять минимальным требованиям, конфигурируемым через параметры паллета L1 POL+DAO (устанавливаются через референдум L1):

```
L2_POL_native ≥ configured_minimum_native
```

Это гарантирует корректность математики XYK и предотвращает dust-атаки.

### 2.3 Защита L2 POL+DAO через казначейство L1

Когда казначейство L1 держит токены L2PDT любого L2 POL+DAO:

- Холдинги L2PDT в казначействе L1 получают множитель голосования 10x (единый для всех L2 POL+DAO)
- Обеспечивает защиту на уровне экосистемы как для инициированных экосистемой, так и для созданных пользователями POL+DAO
- Уровень безопасности определяется фактическими холдингами казначейства L1, а не типом происхождения
- Упрощённая модель безопасности без сложных вычислений ограничений

### 2.4 Требования к долям команды

Если существует распределение для команды:

- Минимальный вестинг 5 лет от последнего минтинга
- Полные права голосования в управлении во время вестинга
- Отсутствие передач до завершения вестинга
- Учитывается в расчётах защиты ограничением

### 2.5 Прозрачность телеметрии

Эмиссия в реальном времени на блокчейне:

- Глубина L2 POL (резервы Native и L2PDT)
- Балансы казначейства (включая заблокированные доли команды)
- Множители силы голоса и состояние убывания
- Уровни участия и распределение наград

### 2.6 Эволюционный дизайн

- Параметры и механизмы системы конфигурируемы через управление
- Протокол может эволюционировать при обнаружении лучших механик
- Изменения требуют консенсуса через установленные пути управления
- Evolution by Design: непрерывное улучшение является основным принципом

---

## 3. Механика управления

### 3.1 Убывающая сила голоса

Вес голоса линейно убывает от 10x до 1x за разные периоды (применяется независимо как к референдумам L1, так и L2):

```rust
fn calculate_voting_power(
    vote_time: Timestamp,
    vote_start: Timestamp,
    vote_end: Timestamp,
    base_weight: Balance,
    is_ecosystem: bool
) -> Balance {
    let progress = (vote_time - vote_start) / (vote_end - vote_start);
    let multiplier = 10.0 - (9.0 * progress);

    // Применяем 10x множитель для холдингов казначейства L1
    let final_multiplier = if is_l1_treasury {
        multiplier * 10.0  // Диапазон 100x-10x для казначейства L1
    } else {
        multiplier
    };

    base_weight * final_multiplier
}
```

**Свойства:**

- Ранняя фиксация получает максимум 10x множитель (100x для холдингов казначейства L1)
- Голосования L2 POL+DAO: период 7 дней по умолчанию
- Голосования L1 Native POL+DAO: период 14 дней при участии
- Линейное убывание предотвращает манипуляции в последнюю минуту
- Казначейство L1 получает супер-множитель 10x на любые холдинги L2PDT (единая модель)

### 3.2 Прогрессивные награды за участие

Активные участники управления получают увеличенные награды:

```rust
fn distribute_rewards(epoch: EpochId) -> Result<(), Error> {
    let base_reward = calculate_base_staking_reward();
    let active_voters = count_active_participants(epoch);
    let passive_stakers = total_stakers - active_voters;

    // Неучастники получают 50% от базовой награды
    let passive_reward = base_reward * 0.5;
    let total_passive_payout = passive_reward * passive_stakers;

    // Пул перераспределения из штрафов
    let penalty_pool = (base_reward * passive_stakers) - total_passive_payout;

    // Активные голосующие делят базовую награду + перераспределение
    let active_reward = base_reward + (penalty_pool / active_voters);

    // Результат: ~2x награды за активное участие
    distribute(passive_stakers, passive_reward);
    distribute(active_voters, active_reward);
}
```

### 3.3 Множитель голосования казначейства

**Холдинги казначейства L1 (все L2 POL+DAO):**

- Когда казначейство L1 держит токены L2PDT любого L2 POL+DAO, они получают 10x вес голоса
- Применяется универсально независимо от того, инициирован ли L2 POL+DAO экосистемой или создан пользователями
- Держатели Native голосуют во втором треке, решая как казначейство L1 применит свои L2PDT голоса
- Уровень защиты масштабируется с фактическим количеством L2PDT в казначействе L1
- Создает экономический стимул для L2 POL+DAO иметь участие казначейства L1

**Управление L2 POL+DAO:**

- L2 POL+DAO использует стандартную убывающую силу голоса (10x до 1x) для всех прямых держателей
- Критические решения могут быть переопределены L1 через вето супер-пользователя
- Система стимулирует сотрудничество через механику превосходства прокси

### 3.4 Механизмы разрешения управления

**Право вето супер-пользователя:**

- Супер-пользователь может наложить вето на любой референдум L2 POL+DAO (как созданный пользователями, так и инициированный экосистемой)
- Вето немедленно отменяет референдум без дальнейшего голосования
- Обеспечивает окончательный механизм безопасности для критических проблем

**Двухтрековая система голосования:**
Когда казначейство L1 держит токены L2PDT, L2 POL+DAO использует двухтрековый механизм голосования:

**Трек 1: Прямое голосование L2PDT**

- Держатели L2PDT голосуют напрямую с убывающей силой (10x до 1x)
- Применяются стандартные правила управления L2 POL+DAO
- Производит победившую позицию (ЗА или ПРОТИВ) с общей силой голосов

**Трек 2: Прокси-голосование Native**

- Держатели Native (L1) голосуют о том, как казначейство L1 должно применить свои холдинги L2PDT
- Решение определяет, голосует ли казначейство L1 своими L2PDT за или против предложения
- L2PDT казначейства L1 получают постоянный множитель 10x

Оба трека работают одновременно в течение 7 дней, затем система определяет результат:

**Путь 1: Консенсус (треки согласованы) - всего 7 дней**

- Оба трека голосуют одинаково (оба ЗА или оба ПРОТИВ)
- L2PDT казначейства L1 получают множитель 10x
- Голоса суммируются: голоса Трека 1 + (L2PDT казначейства L1 × 10)
- Немедленное исполнение после 7 дней

**Путь 2: Расхождение с превосходством прокси (треки в конфликте) - всего 7 дней**

Когда треки голосуют противоположно И Трек 2 с 10x сильнее:

- Пример: Трек 1 голосует 8000 ПРОТИВ, Трек 2 голосует 1000 L2PDT ЗА (×10 = 10000)
- Прокси-голоса Трека 2 (10000 ЗА) превышают победителя Трека 1 (8000 ПРОТИВ)
- Результат: Прокси-позиция побеждает, голоса меньшинства Трека 1 игнорируются
- Финал: 10000 ЗА побеждает, немедленное исполнение (правило превосходства прокси)

**Путь 3: Расхождение с задержкой исполнения (треки в конфликте) - всего 14 дней**

Когда треки голосуют противоположно, НО Трек 1 остается сильнее:

- Пример: Трек 1 голосует 8000 ПРОТИВ, Трек 2 голосует 500 L2PDT ЗА (×10 = 5000)
- Победитель Трека 1 (8000 ПРОТИВ) превышает прокси-голоса Трека 2 (5000 ЗА)
- Результат: Позиция Трека 1 побеждает, но с 7-дневной задержкой исполнения
- Задержка дает время для L1 DAO инициировать референдум вето при необходимости

Критические действия, требующие участия L1 POL+DAO:

- Вывод или модификация L2 POL
- Изменения параметров кривой бондинга
- Расходы казначейства выше порога
- Модификации правил управления

---

## 4. Интеграция с казначейством

### 4.1 Микро-стриминг по блокам

Устраняет MEV через непрерывные микротранзакции:

```rust
struct DripVault {
    total_allocation: Balance,
    blocks_remaining: BlockNumber,
    amount_per_block: Balance,
}

impl DripVault {
    fn initialize(allocation: Balance, duration_blocks: BlockNumber) -> Self {
        Self {
            total_allocation: allocation,
            blocks_remaining: duration_blocks,
            amount_per_block: allocation / duration_blocks,
        }
    }

    fn execute_block(&mut self) -> Balance {
        if self.blocks_remaining > 0 {
            self.blocks_remaining -= 1;
            self.amount_per_block  // Сумма слишком мала для прибыльного MEV
        } else {
            0
        }
    }
}
```

**Пример конфигурации:**

```
2-летний поток: 2 * 365 * 7200 блоков = 5,256,000 блоков
Сумма на блок: 10,000 NATIVE / 5,256,000 = 0.0019 NATIVE
Прибыль MEV: price_impact(0.0019) - gas_cost < 0 ✓
```

(amount_per_block, 0)
}

### 4.2 Режимы участия казначейства

1. **Разовое семя** — Немедленный обмен для стратегической позиции
2. **Поток DripVault** — Непрерывная поддержка в течение месяцев/лет
3. **Рециклирование доходов** — Процент дохода автоматически конвертируется в L2PDT

---

## 5. Жизненный цикл L2 POL+DAO

### 5.1 Фаза генезиса

**Требования для регистрации:**

- Тип происхождения (инициированный экосистемой или созданный пользователями)
- Конфигурация механизма эмиссии (параметры UTBC, правила кастомного минтинга и т.д.)
- Распределение долей (user, l2_pol, treasury, team)
- График вестинга команды (минимум 5 лет)
- Конфигурация управления
- Начальный Native для минимума L2 POL (минимум устанавливается через референдум L1)

**Проверки валидации:**

- Сумма долей равна ровно 100%
- Доля L2 POL ≥ 20%
- Начальный Native соответствует минимальным требованиям (конфигурируется через параметры паллета L1 POL+DAO)
- Происхождение экосистемы проверено, если запрашивается экосистемное финансирование

### 5.2 Фаза запуска

**Последовательность активационного минтинга:**

1. Блокировка начального вклада Native
2. Выполнение первого минтинга через настроенный механизм эмиссии (UTBC или кастомный)
3. Создание пула XYK с аллокацией L2 POL
4. Настройка LP токенов согласно режиму управления POL (заблокированные или на балансе казначейства)
5. Распределение казначейских и командных аллокаций
6. Активация механизмов управления

### 5.3 Операционная фаза

**Непрерывные операции:**

- Каждый минтинг проверяет ограничение и направляет в L2 POL
- Предложения следуют пути двойного одобрения для критических действий
- Награды за участие рассчитываются и распределяются каждую эпоху
- DripVault выполняет потоковое вещание по блокам при настройке

### 5.4 Метрики зрелости

L2 POL+DAO считается зрелой при:

- Глубина L2 POL > 100,000 эквивалента NATIVE
- 6 месяцев положительного денежного потока
- Средний уровень участия > 30%
- Отсутствие вето критических предложений в течение 3 месяцев

---

## 6. Паттерн BLDR

### 6.1 Архитектура

BLDR служит канонической реализацией L2 POL+DAO (использующей UTBC) для прозрачной системы выплат:

```rust
struct BldrConfig {
    team_share: Permill,        // 0% для чистой модели казначейства
    treasury_share: Permill,    // 100% если нет команды
    invoice_cooldown: BlockNumber,
    max_invoice_size: Balance,
}
```

### 6.2 Поток счетов

1. **Подача** — Контрибьютор подаёт счёт с хешем результатов
2. **Голосование** — Держатели BLDR голосуют по одобрению счёта
3. **Одобрение** — При прохождении входит в очередь исполнения
4. **Оплата** — Автоматическая выплата в BLDR или Native
5. **Отслеживание** — Ончейн-ссылка на выполненную работу

### 6.3 Экономический цикл

```
Казначейство засевает BLDR → Контрибьюторы зарабатывают → Некоторые продают за Native →
Цена XYK падает → Выкуп казначейства → Повторная блокировка с множителем →
Более сильное управление → Лучшие решения → Больше ценности → Повторение
```

---

## 7. Модель безопасности

### 7.1 Векторы атак и меры противодействия

| Вектор атаки               | Противодействие                               | Формула стоимости                                  |
| -------------------------- | --------------------------------------------- | -------------------------------------------------- |
| **Захват через минтинг**   | Множитель 10x казначейства L1                 | `стоимость > l1_treasury_holdings × 10`            |
| **Мгновенное управление**  | Убывающая сила голоса                         | `стоимость = full_position × 10 × lock_time`       |
| **Захват L1 Native**       | Переопределение veto для критических действий | `стоимость > native_market_cap × quorum%`          |
| **Эксплуатация MEV**       | Потоковое вещание по блокам                   | `прибыль < 0` (невыгодно)                          |
| **Истощение казначейства** | Трёхпутевое разрешение + пороги               | Требует переопределение L1 или согласие L2 POL+DAO |

### 7.2 Экономическая безопасность

Минимальная стоимость атаки для любого L2 POL+DAO:

```
Attack_cost = min(
    l1_treasury_l2pdt × 10,      // Если казначейство L1 держит L2PDT
    circulating_l2pdt × price × 5, // Нужно >50% с 1x против ранних 10x голосов
    native_market_cap × 0.1,      // Захват L1 Native
    opportunity_cost(10x_lockup)  // Капитал, взвешенный по времени
)
```

**Ключевой инсайт:** Защита масштабируется с инвестициями казначейства L1, а не с типом происхождения. Созданные пользователями POL+DAO получают защиту экосистемного уровня, когда казначейство L1 приобретает их токены.

### 7.3 Уровни защиты

- **Математический** — Экосистемные L2 POL+DAO: множитель 10x обеспечивает доминирование L1 Treasury

2. **Экономический** — Стоимость атаки превышает потенциальную выгоду через множественные механизмы
3. **Временной** — Трёхпутевое разрешение обеспечивает соответствующие окна реагирования
4. **Социальный** — Прозрачные операции обеспечивают мониторинг
5. **Иерархический** — Экосистемный origin предоставляет дополнительный уровень безопасности

---

## 8. Параметры конфигурации

### 8.1 Рекомендуемые значения по умолчанию

```rust
const DEFAULT_CONFIG: L2PolDaoConfig = L2PolDaoConfig {
    // Доли
    l2_pol_share: Permill::from_percent(33),
    treasury_share: Permill::from_percent(33),
    user_share: Permill::from_percent(34),
    team_share: Permill::from_percent(0),  // Или до 11%

    // Управление
    ecosystem_multiplier: 10,  // Для экосистемных L2 POL+DAO
    treasury_multiplier: 3,    // Для обычных L2 POL+DAO
    voting_period: 7 * DAYS,
    native_voting_period: 14 * DAYS,
    veto_override_threshold: 14 * DAYS,

    // Экономика
    min_native_floor: 1000 * UNITS,
    min_mint_amount: 100 * UNITS,
    buyback_threshold: Permill::from_percent(95),

    // Стриминг
    default_drip_duration: 2 * YEARS,
    blocks_per_drip: 1,
};
```

### 8.2 Схемы управления

**Схема экосистемных L2 POL+DAO:**

- Native Treasury получает множитель голосования 10x
- Трёхпутевое разрешение (только L2 POL+DAO, консенсус или veto)
- Подходит для проектов, финансируемых экосистемой

**Схема обычного L2 POL+DAO:**

- Стандартная убывающая сила голоса (10x до 1x)
- Опциональное участие L1 POL+DAO
- Подходит для проектов, инициированных сообществом

**Чистая схема L1-Proxy:**

- Все решения через референдум L1 POL+DAO
- L2PDT чисто экономический
- Подходит для требований максимальной безопасности

---

## 9. Требования к реализации

### 9.1 Основные паллеты

```rust
trait L2PolDaoPallet {
    // Жизненный цикл
    fn register_dao(config: L2PolDaoConfig, origin: Origin) -> Result<DaoId, Error>;
    fn activate_dao(dao_id: DaoId, initial_native: Balance) -> Result<(), Error>;

    // Минтинг (реализация зависит от механизма эмиссии)
    fn mint(dao_id: DaoId, amount: Balance) -> Result<Balance, Error>;
    fn custom_emission(dao_id: DaoId, params: EmissionParams) -> Result<Balance, Error>;

    // Управление
    fn cast_vote(proposal: ProposalId, weight: Balance, conviction: u8);
    fn calculate_voting_power(
        voter: AccountId,
        time: Timestamp,
        is_l1_treasury: bool
    ) -> Balance;
    fn resolve_proposal(proposal: ProposalId) -> ResolutionPath;

    // Управление L2 POL
    fn add_liquidity_to_l2_pol(dao_id: DaoId, native: Balance, l2pdt: Balance);
    fn get_l2_pol_reserves(dao_id: DaoId) -> (Balance, Balance);
```

### 9.2 Критические хуки

```rust
trait Hooks {
    fn on_mint(dao_id: DaoId, amount: Balance);
    fn on_vote_cast(voter: AccountId, power: Balance);
    fn on_proposal_executed(proposal: ProposalId);
    fn on_participation_reward(voter: AccountId, reward: Balance);
}
```

### 9.3 Хранилище

- Резервы L2 POL и отслеживание LP токенов
- Графики убывания силы голоса
- История участия для наград
- Графики вестинга казначейства и команды
- Состояния потокового вещания DripVault

---

## Заключение

Архитектура L2 POL+DAO позволяет DAO второго уровня работать с математическими гарантиями безопасности через:

1. **Убывающую силу голоса**, предотвращающую атаки на управление в последний момент
2. **Потоковое вещание по блокам**, полностью устраняющий MEV
3. **Прогрессивные награды**, стимулирующие активное участие
4. **Неизменность L2 POL**, обеспечивающую постоянную ликвидность второго уровня
5. **Двухтрековое управление** с задержкой исполнения для потенциального вето L1
6. **Единый множитель 10x** для холдингов казначейства L1 в любом L2 POL+DAO
7. **Evolution by Design**, обеспечивающий непрерывное улучшение протокола

Система создаёт устойчивые токеномические модели, где токены L2PDT несут силу управления с обязательной поддержкой ликвидности второго уровня (L2 POL), а участие казначейства обеспечивает выравнивание интересов без традиционных командных распределений, сохраняя при этом безопасность через экономические стимулы, а не бюрократические структуры.

---

**Версия:** 1.0.0
**Дата:** Октябрь 2025
**Лицензия:** MIT
